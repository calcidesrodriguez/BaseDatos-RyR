<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inversiones RyR | Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #0f172a; 
            --accent: #3b82f6; 
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #334155;
            --green: #10b981;
            --purple: #8b5cf6;
            --orange: #f59e0b;
        }

        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 80px; background: var(--primary); display: flex; flex-direction: column; align-items: center; padding: 20px 0; flex-shrink: 0; transition: width 0.3s; z-index: 100; }
        .sidebar:hover { width: 200px; }
        .brand { color: white; font-size: 1.5rem; margin-bottom: 40px; }
        .nav-item { color: #94a3b8; width: 100%; padding: 15px 0; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.2s; position: relative; }
        .nav-item i { font-size: 1.4rem; }
        .nav-item span { display: none; margin-left: 15px; white-space: nowrap; font-size: 0.9rem; font-weight: 600; }
        .sidebar:hover .nav-item span { display: inline; }
        .sidebar:hover .nav-item { justify-content: flex-start; padding-left: 25px; }
        .nav-item.active { color: white; border-left: 4px solid var(--accent); background: rgba(255,255,255,0.05); }

        /* MAIN */
        .main-content { flex: 1; padding: 25px; overflow-y: auto; max-width: 800px; margin: 0 auto; width: 100%; }
        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- FILTROS DE FRECUENCIA (NUEVO) --- */
        .filter-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 20px; scrollbar-width: none; }
        .filter-btn { 
            padding: 8px 16px; border-radius: 20px; border: 1px solid #e2e8f0; background: white; 
            color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; white-space: nowrap; transition: 0.2s;
        }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .filter-btn:hover { border-color: var(--accent); color: var(--accent); }
        .filter-btn.active:hover { color: white; }

        /* CLIENT CARD */
        .client-card { 
            background: var(--surface); border-radius: 16px; padding: 20px; margin-bottom: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; 
            display: flex; flex-direction: column; gap: 15px;
        }

        .card-header { display: flex; justify-content: space-between; align-items: start; }
        .client-name { font-size: 1.1rem; font-weight: 700; color: var(--primary); margin: 0; }
        .client-sub { font-size: 0.85rem; color: #64748b; margin-top: 2px; }
        
        /* ETIQUETAS DE FRECUENCIA (COLOR CODING) */
        .tag { padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .tag-diario { background: #dbeafe; color: #1e40af; }     /* Azul */
        .tag-semanal { background: #dcfce7; color: #166534; }    /* Verde */
        .tag-quincenal { background: #f3e8ff; color: #6b21a8; }  /* Morado */
        .tag-mensual { background: #ffedd5; color: #9a3412; }    /* Naranja */

        /* BOT√ìN PAGO */
        .pay-btn { 
            background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; 
            font-weight: 700; cursor: pointer; width: 100%; display: flex; justify-content: space-between; align-items: center;
        }
        .pay-btn:active { transform: scale(0.98); }
        .pay-btn i { background: rgba(255,255,255,0.2); padding: 5px; border-radius: 50%; }

        /* PROGRESO */
        .progress-dots { display: flex; gap: 4px; margin-top: 10px; flex-wrap: wrap; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #e2e8f0; }
        .dot.paid { background: var(--green); }
        .dot.current { background: var(--accent); transform: scale(1.4); }

        /* FORMULARIOS */
        input, select { width: 100%; padding: 14px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; margin-bottom: 15px; font-size: 1rem; box-sizing: border-box; outline: none; }
        .btn-block { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1rem; }

        @media (max-width: 768px) {
            .sidebar { width: 100%; height: 60px; position: fixed; bottom: 0; flex-direction: row; justify-content: space-around; padding: 0; }
            .sidebar:hover { width: 100%; }
            .nav-item { flex-direction: column; font-size: 0.7rem; padding: 10px; }
            .nav-item span { display: block; margin: 0; font-size: 0.6rem; }
            .main-content { margin-bottom: 70px; padding: 15px; }
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="brand"><i class="fas fa-layer-group"></i></div>
        <div class="nav-item active" onclick="nav('cartera', this)"><i class="fas fa-wallet"></i> <span>Cartera</span></div>
        <div class="nav-item" onclick="nav('arqueo', this)"><i class="fas fa-receipt"></i> <span>Arqueo</span></div>
        <div class="nav-item" onclick="nav('nuevo', this)"><i class="fas fa-plus"></i> <span>Nuevo</span></div>
    </nav>

    <main class="main-content">

        <div id="cartera" class="section active">
            
            <input type="text" placeholder="üîç Buscar cliente..." onkeyup="searchFilter(this.value)" 
                   style="width:100%; padding:15px; border-radius:50px; border:1px solid #cbd5e1; margin-bottom:15px;">

            <div class="filter-scroll">
                <button class="filter-btn active" onclick="filterFreq('Todos', this)">Todos</button>
                <button class="filter-btn" onclick="filterFreq('Diario', this)">Diarios</button>
                <button class="filter-btn" onclick="filterFreq('Semanal', this)">Semanales</button>
                <button class="filter-btn" onclick="filterFreq('Quincenal', this)">Quincenales</button>
                <button class="filter-btn" onclick="filterFreq('Mensual', this)">Mensuales</button>
            </div>
            
            <div id="loading" style="text-align:center; padding:40px; color:#94a3b8;">
                <i class="fas fa-circle-notch fa-spin fa-2x"></i><br>Cargando...
            </div>
            
            <div id="lista-clientes"></div>
        </div>

        <div id="arqueo" class="section">
            <h2>Movimientos del D√≠a</h2>
            <div id="tabla-arqueo"></div>
        </div>

        <div id="nuevo" class="section">
            <div style="background:white; padding:25px; border-radius:16px; border:1px solid #e2e8f0;">
                <h2 style="margin-top:0; text-align:center;">Nuevo Cr√©dito</h2>
                <form id="formNuevo">
                    <input type="text" id="cli" placeholder="Nombre del Cliente" required>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <input type="number" id="monto" placeholder="Monto" oninput="calc()" required>
                        <input type="number" id="porc" placeholder="%" value="20" oninput="calc()">
                    </div>
                    
                    <label style="font-weight:bold; font-size:0.8rem; color:#64748b;">FRECUENCIA DE COBRO</label>
                    <div style="display:grid; grid-template-columns: 1.5fr 1fr; gap:10px;">
                        <select id="frecuencia">
                            <option value="Diario">Diario</option>
                            <option value="Semanal" selected>Semanal</option>
                            <option value="Quincenal">Quincenal</option>
                            <option value="Mensual">Mensual</option>
                        </select>
                        <input type="number" id="cantidad" placeholder="# Cuotas" value="10" oninput="calc()" required>
                    </div>

                    <input type="number" id="cuota" placeholder="Valor Cuota" oninput="calc()">
                    <input type="number" id="tel" placeholder="Tel√©fono">
                    
                    <div style="background:#f1f5f9; padding:15px; border-radius:10px; margin-bottom:20px; text-align:center;">
                        <small>TOTAL A COBRAR</small>
                        <div style="font-size:1.5rem; font-weight:800; color:var(--primary)" id="out_total">$0</div>
                    </div>

                    <button type="submit" class="btn-block">Guardar Pr√©stamo</button>
                </form>
            </div>
        </div>

    </main>

<script>
    // ‚ö†Ô∏è TU URL AQU√ç ‚ö†Ô∏è
    const API = "https://script.google.com/macros/s/AKfycbz_3MME39zI1PQXsZgazoHZPR73RSvpDfJFuHsrq4RXB5rtXh6TAuaoSyF4qiHwXkY7/exec";

    const f = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 });
    let globalData = [];
    let currentFilter = 'Todos';

    // INICIO
    fetch(API).then(r => r.json()).then(data => {
        globalData = data;
        document.getElementById('loading').style.display = 'none';
        renderCartera(data);
        renderArqueo(data);
    });

    function nav(id, btn) {
        document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    // --- FILTRADO INTELIGENTE ---
    function filterFreq(freq, btn) {
        currentFilter = freq;
        // Actualizar botones visualmente
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Filtrar datos
        if (freq === 'Todos') {
            renderCartera(globalData);
        } else {
            const filtered = globalData.filter(c => c.frecuencia === freq);
            renderCartera(filtered);
        }
    }

    function searchFilter(txt) {
        const term = txt.toLowerCase();
        // Filtrar sobre los datos globales primero
        const filtered = globalData.filter(c => 
            (c.cliente.toLowerCase().includes(term)) && 
            (currentFilter === 'Todos' || c.frecuencia === currentFilter)
        );
        renderCartera(filtered);
    }

    // --- RENDER CARTERA ---
    function renderCartera(data) {
        const list = document.getElementById('lista-clientes');
        list.innerHTML = '';

        if(data.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#cbd5e1; margin-top:20px;">No hay clientes en esta categor√≠a.</div>';
            return;
        }
        
        data.slice().reverse().forEach(c => {
            let pagos = JSON.parse(c.pagos || '[]');
            const cuotasTotal = parseInt(c.cantidad) || 1;
            const pagadas = pagos.length;
            const siguiente = pagadas + 1;
            const frec = c.frecuencia || "Semanal";
            const valCuota = parseFloat(c.cuota);
            const isCompleted = pagadas >= cuotasTotal;

            // Determinar color de etiqueta
            let tagClass = 'tag-semanal';
            if(frec === 'Diario') tagClass = 'tag-diario';
            if(frec === 'Quincenal') tagClass = 'tag-quincenal';
            if(frec === 'Mensual') tagClass = 'tag-mensual';

            const div = document.createElement('div');
            div.className = 'client-card';
            div.innerHTML = `
                <div class="card-header">
                    <div>
                        <h3 class="client-name">${c.cliente}</h3>
                        <div class="client-sub"><i class="fas fa-phone"></i> ${c.telefono}</div>
                    </div>
                    <span class="tag ${tagClass}">${frec}</span>
                </div>

                ${!isCompleted ? `
                <button class="pay-btn" onclick="pagar(${c.row}, ${siguiente}, ${valCuota})">
                    <span>Pagar Cuota #${siguiente}</span>
                    <span>${f.format(valCuota)} <i class="fas fa-chevron-right"></i></span>
                </button>
                ` : `
                <div style="background:#f0fdf4; color:#166534; padding:10px; border-radius:8px; text-align:center; font-weight:bold;">
                    <i class="fas fa-check-circle"></i> PAGADO
                </div>
                `}

                <div class="progress-dots">
                    ${generateDots(cuotasTotal, pagadas)}
                </div>
            `;
            list.appendChild(div);
        });
    }

    function generateDots(total, pagadas) {
        let html = '';
        for(let i=1; i<=total; i++) {
            let status = '';
            if(i <= pagadas) status = 'paid';
            else if(i === pagadas + 1) status = 'current';
            html += `<div class="dot ${status}"></div>`;
        }
        return html;
    }

    // --- PAGAR ---
    function pagar(rowId, num, valor) {
        if(!confirm(`¬øRegistrar pago de ${f.format(valor)}?`)) return;

        const hoy = new Date();
        const fechaStr = `${hoy.getHours()}:${String(hoy.getMinutes()).padStart(2,'0')} - ${hoy.getDate()}/${hoy.getMonth()+1}`;

        const cli = globalData.find(x => x.row === rowId);
        let pagos = JSON.parse(cli.pagos || '[]');
        pagos.push(fechaStr);
        cli.pagos = JSON.stringify(pagos);
        
        // Re-renderizar respetando el filtro actual
        if (currentFilter === 'Todos') renderCartera(globalData);
        else renderCartera(globalData.filter(c => c.frecuencia === currentFilter));
        
        renderArqueo(globalData);

        fetch(API, {
            method: 'POST',
            body: JSON.stringify({ action: 'pago', row: rowId, pagos: cli.pagos })
        });
    }

    // --- ARQUEO ---
    function renderArqueo(data) {
        const div = document.getElementById('tabla-arqueo');
        div.innerHTML = '';
        const hoyStr = `${new Date().getDate()}/${new Date().getMonth()+1}`; // ej: 4/2
        
        data.forEach(c => {
            let pagos = JSON.parse(c.pagos || '[]');
            pagos.forEach(p => {
                if(p.includes(hoyStr)) { // Si el pago tiene la fecha de hoy
                    const item = document.createElement('div');
                    item.style = "background:white; padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;";
                    item.innerHTML = `
                        <span>${c.cliente}</span>
                        <span style="font-weight:bold; color:var(--green)">${f.format(c.cuota)}</span>
                    `;
                    div.appendChild(item);
                }
            });
        });
    }

    // --- NUEVO ---
    function calc() {
        const P = parseFloat(document.getElementById('monto').value) || 0;
        const I = parseFloat(document.getElementById('porc').value) || 0;
        const Q = parseFloat(document.getElementById('cantidad').value) || 0;
        
        const gan = P * (I/100);
        const ent = P - gan;
        
        // Si no hay cuota manual, sugerimos
        if(document.getElementById('cuota').value == "") {
            document.getElementById('cuota').placeholder = f.format(P/Q);
        }
        
        const C = parseFloat(document.getElementById('cuota').value) || (P/Q);
        document.getElementById('out_total').innerText = f.format(C * Q);
        
        return { P, I, Q, C, ent, gan, tot: C*Q };
    }

    document.getElementById('formNuevo').onsubmit = (e) => {
        e.preventDefault();
        const v = calc();
        document.querySelector('.btn-block').innerText = "Guardando...";
        
        fetch(API, {
            method: 'POST',
            body: JSON.stringify({
                action: 'nuevo',
                cliente: document.getElementById('cli').value,
                telefono: document.getElementById('tel').value,
                prestamo: v.P, porcentaje: v.I, entregado: v.ent,
                ganancia: v.gan, 
                cantidad: v.Q, 
                frecuencia: document.getElementById('frecuencia').value,
                cuota: v.C, totalRecaudo: v.tot
            })
        }).then(() => { alert("Guardado"); location.reload(); });
    }
</script>
</body>
</html>
